<canvas id="canvas1" width="512" height="256" ></canvas>
<canvas id="canvas2" width="512" height="256" ></canvas>

<p id="controls">
  <input type="button" id="start_button" value="Start">
  &nbsp; &nbsp;
  <input type="button" id="stop_button" value="Stop">
</p>

<!-- ----------------------------------------------------- -->

<style>
    #canvas1, #canvas2 {
        margin-left: auto;
        margin-right: auto;
        display: block;
        background-color: black;
    }
    #controls {
        text-align: center;
    }
    #start_button, #stop_button {
        font-size: 16pt;
    }
</style>

<!-- ----------------------------------------------------- -->

<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
<script type="text/javascript">
    // Hacks to deal with different function names in different browsers
    window.requestAnimFrame = (function(){
      return  window.requestAnimationFrame       ||
              window.webkitRequestAnimationFrame ||
              window.mozRequestAnimationFrame    ||
              function(callback, element){
                window.setTimeout(callback, 1000 / 60);
              };
    })();
    window.AudioContext = (function(){
        return  window.webkitAudioContext || window.AudioContext || window.mozAudioContext;
    })();
    // Global Variables for Audio
    var audioContext = new AudioContext();
    
    $(document).ready(function() {

    	var testNode = function (elementId, audioUrl) {
        	var sourceNode;
		    var analyserNode;
		    var javascriptNode;
		    var audioData = null;
		    var audioPlaying = false;
		    var sampleSize = 1024;  // number of samples to collect before analyzing data
		    var dataArray;     // array to hold time domain data
		    // Global Variables for the Graphics
		    var canvasWidth  = 512;
		    var canvasHeight = 256;
		    var ctx = $("#" + elementId).get()[0].getContext("2d");

        	// Play the audio and loop until stopped
		    function playSound(buffer) {
		        sourceNode.buffer = buffer;
		        sourceNode.start(0);    // Play the sound now

		        sourceNode.loop = true;
		        audioPlaying = true;
		    }

	        // Load the audio from the URL via Ajax and store it in global variable audioData
		    // Note that the audio load is asynchronous
		    function loadSound(url) {
		        var request = new XMLHttpRequest();
		        request.open('GET', url, true);
		        request.responseType = 'arraybuffer';
		        // When loaded, decode the data and play the sound
		        request.onload = function () {
		            audioContext.decodeAudioData(request.response, function (buffer) {
		                audioData = buffer;
		                playSound(audioData);
		            }, function (e) {
				        console.log(e);
				    });
		        }
		        request.send();
		    }

	        function drawTimeDomain() {
			    function clearCanvas() {
			        ctx.clearRect(0, 0, canvasWidth, canvasHeight);
			    }
		        clearCanvas();
		        
		        for (var i = 0; i < dataArray.length; i++) {
		            var value = dataArray[i] / 256;
		            var y = canvasHeight - (canvasHeight * value) - 1;
		            ctx.fillStyle = '#ffffff';
		            ctx.fillRect(i, y, 1, 1);
		        }

		        /*ctx.fillStyle = 'rgb(0, 0, 0)';
		        ctx.fillRect(0, 0, canvasWidth, canvasHeight);

		        var barWidth = (canvasWidth / dataArray.length) * 2.5;
				var barHeight;
				var x = 0;

		        for(var i = 0; i < dataArray.length; i++) {
			        barHeight = dataArray[i] / 2;

			        ctx.fillStyle = 'rgb(' + (barHeight+100) + ',50,50)';
			        ctx.fillRect(x,canvasHeight-barHeight/2,barWidth,barHeight);

			        x += barWidth + 1;
			    }*/
		    }

		    

            // Set up the audio Analyser, the Source Buffer and javascriptNode
            sourceNode     = audioContext.createBufferSource();
	        analyserNode   = audioContext.createAnalyser();
	        javascriptNode = audioContext.createScriptProcessor(sampleSize, 1, 1);
	        // Create the array for the data values
	        dataArray = new Uint8Array(analyserNode.frequencyBinCount);
	        // Now connect the nodes together


	        // add lowerPassFilter on the canvas2
			if (elementId == 'canvas2') {
				var filter = audioContext.createBiquadFilter();
				filter.type = 'lowpass';

				sourceNode.connect(audioContext.destination);
		        sourceNode.connect(filter);
		        filter.connect(analyserNode);
		        analyserNode.connect(javascriptNode);
				javascriptNode.connect(audioContext.destination);
			} else {
				sourceNode.connect(audioContext.destination);
		        sourceNode.connect(analyserNode);
		        analyserNode.connect(javascriptNode);
	        	javascriptNode.connect(audioContext.destination);
			}

            // setup the event handler that is triggered every time enough samples have been collected
            // trigger the audio analysis and draw the results
            javascriptNode.onaudioprocess = function () {
                // get the Time Domain data for this sample
                
                analyserNode.getByteTimeDomainData(dataArray);
                //analyserNode.getByteFrequencyData(dataArray);
                
                // draw the display if the audio is playing
                if (audioPlaying == true) {
                    requestAnimFrame(drawTimeDomain);
                }
            }
            // Load the Audio the first time through, otherwise play it from the buffer
            if(audioData == null) {
                loadSound(audioUrl);
            } else {
                playSound(audioData);
            }

	        // Stop the audio playing
	        $("#stop_button").one('click', function(e) {
	            e.preventDefault();
	            sourceNode.stop(0);
	            audioPlaying = false;
	        });
    	}

        // the AudioContext is the primary 'container' for all your audio node objects
        // gather samples for the analysis, update the canvas
        $("#start_button").on('click', function(e) {
            e.preventDefault();

            testNode('canvas1', "/media/new_order-blue_monday1.wav");
            testNode('canvas2', "/media/new_order-blue_monday2.wav");
        });
    });




</script>